#! /bin/env python
# -*- coding: utf-8 -*-

import sys
import cPickle

from os.path import splitext, basename
from optparse import OptionParser
from pprint import pformat

try:
    from scipy.io.mio import loadmat
except ImportError:
    from scipy.io.matlab import loadmat

import numpy as _N

import pyhrf
from pyhrf import xmlio
import pyhrf.viewer.qt3 as ndview
from pyhrf.tools._io import read_volume, MRI3Daxes, MRI4Daxes
from pyhrf.ndarray import xndarray


def applyTrueLabelMask(views, sessionNames):
    print 'applyTrueLabelMask ...'
    if views.has_key('labels'):
        print 'got labels !'
        labc = views['labels'].cuboid
        print 'labc:',
        print labc.descrip()
        mlabels = xndarray(labc.data + 1, axes_names=labc.getAxesNames(),
                           axesDomains=labc.getAxesDomainsDict(),
                           valueLabel=labc.getValueLabel())
        for vn, v in views.items():
            print '%s ...', vn
            try:
                v.applyMask(mlabels)
            except Exception, e:
                print 'couldnt apply mask to', vn
                print v.cuboid.descrip()
                print 'exception:'
                print e
                print ''
            print ''
    sys.stdout.flush()


def getSessionName(fn):
    if splitext(fn)[-1] == '.pck':
        output = cPickle.load(open(fn, 'r'))
        if type(output) == dict:
            return output.keys()
    return None


def parseXmlFile(fn):
    f = open(fn, 'r')
    so = f.read()
    o = xmlio.fromXML(so, handler=xmlio.xmlnumpy.NumpyXMLHandler())
    for on, ov in o.iteritems():
        o[on] = ov.cuboid
    return o


def parsePickledFile(fn):
    print 'Viewing a pickled file ...'
    print 'Loading outputs ...'
    output = cPickle.load(open(fn, 'r'))
    print 'outputs loaded !'
    key = basename(fn)
    if type(output) == dict:
        return getDictOutput(output)
    elif type(output) == _N.ndarray:
        if len(output.shape) == 3:
            return {key: xndarrayView(xndarray(output, axes_names=MRI3Daxes))}
        elif len(output.shape) == 4:
            return {key: xndarrayView(xndarray(output, axes_names=MRI4Daxes))}
        else:
            return {key: xndarrayView(xndarray(output))}
    elif isinstance(output, xndarray):
        return {key: xndarrayView(output)}


def getDictOutput(output):
    print 'Packing views ...'
    mask = output.pop('roiMask', None)

    dataType = output.get('dataType', 'jdeAnalysis')

    if dataType == 'jdeAnalysis':
        dataViews = {}
        for idObj, data in output.items():
            try:
                v = ndview.core.xndarrayView(data)
                try:
                    if mask is not None:
                        v.applyMask(mask, 'ROI')
                except Exception, e:
                    print 'In applying mask :'
                    print repr(e)
                dataViews[idObj] = v
            except Exception, e:
                print 'Couldn\'t build a view for', idObj
                print '->', repr(e)
        print 'Done !'
        return dataViews
    else:
        print 'Datatype not understood !'
        sys.exit(1)


usage = 'usage: %%prog [options] FILES '

description = 'Viewer of files handled by pyhrf:\n ' \
              ' - nifti image (.nii)' \
              ' - matlab file (mat) [printed to stdout]'

parser = OptionParser(usage=usage, description=description)


parser.add_option('-v', '--verbose', dest='verbose', metavar='VERBOSELEVEL',
                  type='int', default=0,
                  help=pformat(pyhrf.verbose_levels))
parser.add_option('-m', '--mask-file', dest='maskFile', metavar='FILE',
                  help="n-ary mask to be applied on viewed data")
parser.add_option('-n', '--mask-name', dest='maskName', metavar='STRING',
                  help="Name of mask", default='mask')


(options, args) = parser.parse_args()
# pyhrf.verbose.set_verbosity(options.verbose)
pyhrf.logger.setLevel(options.verbose)

files = args

if options.maskFile is not None:
    if options.maskFile not in files:
        files.append(options.maskFile)
    mExt = splitext(options.maskFile)[1]
    if mExt == '.ima':
        mask, headMask = readImageWithAims(options.maskFile)
        mask = xndarray(mask, axes_names=['axial', 'coronal', 'sagittal'])
    elif mExt == '.img' or mExt == '.nii':
        mask = xndarray.load(options.maskFile)
    elif mExt == '.pck':
        mask = cPickle.load(open(options.maskFile))
        mask = xndarray(mask, axes_names=['axial', 'coronal', 'sagittal'])
    assert mask.get_ndims() == 3
else:
    mask = None

views = {}
volsToStack = []
print ''
print 'files:', files
print ''
for f in files:
    print 'doing:', f
    base, ext = splitext(f)
    if ext == '.gz':
        base, ext = splitext(f[:-3])
    if ext == '.mat':
        print 'Printing the content of the mat file :'
        print ' ', f
        spm = loadmat(f)
        print pformat(spm)
        sys.exit(0)
    elif ext == '.pck':
        views.update(parsePickledFile(f))
    elif ext == '.xml':
        views.update(parseXmlFile(f))
    elif ext == '.nii' or ext == '.ima' or ext == '.img' \
            or ext == '.gii':
        if ext == '.nii' or ext == '.img':
            data, header = read_volume(f)
            if data.dtype == _N.int16:
                data = data.astype(_N.int32)
        elif ext == '.ima':
            data, header = read_volume(f)
        tmp = basename(f)
        name = basename(f)
        i = 1
        while views.has_key(tmp):
            tmp = name + "(%d)" % i
            i += 1
        name = tmp
        print 'name :', name
        views[name] = xndarray.load(f)
    else:
        print '"%s": unrecognized extension !' % f

print 'Calling multiView (mask=%s)...' % str(mask)
ndview.multiView(views, mask)
sys.exit(0)
